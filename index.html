<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì£¼ë¦°ì´ ì‹œë®¬ë ˆì´í„° - IT008</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Pretendard', sans-serif; }
        .card { background-color: #1e1e1e; border: 1px solid #333; margin-bottom: 20px; }
        .text-red { color: #ff4d4d; }
        .text-blue { color: #4d79ff; }
        
        /* ë‰´ìŠ¤ ì „ê´‘íŒ ìŠ¤íƒ€ì¼ */
        .news-ticker-box {
            background-color: #2c0b0e; 
            border: 1px solid #ff4d4d; 
            color: #ffcccc;
            padding: 10px;
            margin-bottom: 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .news-badge {
            background-color: #ff4d4d;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 10px;
            font-size: 0.8rem;
        }

        .mentor-card { padding: 12px; margin-bottom: 8px; border-radius: 8px; font-size: 0.95rem; }
        .value-box { background-color: #2c3e50; border-left: 4px solid #f1c40f; }
        .momentum-box { background-color: #c0392b; border-left: 4px solid #e74c3c; }
        .contrarian-box { background-color: #5d6d7e; border-left: 4px solid #2e86c1; }
        
        .price-up { animation: blink-red 0.5s; }
        .price-down { animation: blink-blue 0.5s; }
        @keyframes blink-red { 0% { background-color: rgba(255,0,0,0.3); } 100% { background-color: transparent; } }
        @keyframes blink-blue { 0% { background-color: rgba(0,0,255,0.3); } 100% { background-color: transparent; } }
    </style>
</head>
<body class="container py-4">

    <div class="row mb-3 text-center">
        <div class="col-12">
            <h4 class="text-muted">Agent Market Simulator</h4>
            <h2 id="stock-name">Loading...</h2>
            <h1 id="current-price" class="display-3 fw-bold">0 KRW</h1>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card p-3">
                <canvas id="priceChart" height="150"></canvas>
            </div>

            <div class="news-ticker-box">
                <span class="news-badge">LIVE NEWS</span>
                <span id="news-text">ì‹œì¥ì˜ ì†Œì‹ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...</span>
            </div>
            
            <div class="card p-3">
                <h5>ğŸ’¬ AI ë©˜í†  ë¦¬ì–¼íƒ€ì„ í”¼ë“œë°±</h5>
                <div id="mentor-area" style="min-height: 100px;">
                    <small class="text-muted">ë©˜í† ë“¤ì´ ì‹œì¥ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</small>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card p-3">
                <h5 class="text-center mb-3">Order Book</h5>
                <table class="table table-dark table-sm text-center align-middle">
                    <thead><tr class="text-muted"><th>ê°€ê²©</th><th>ìˆ˜ëŸ‰</th></tr></thead>
                    <tbody id="sell-book" class="text-blue fs-5"></tbody>
                    <tbody id="buy-book" class="text-red fs-5"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const ctx = document.getElementById('priceChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'ì£¼ê°€ íë¦„',
                    data: [],
                    borderColor: '#4caf50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: false, grid: { color: '#333' } }, x: { grid: { display: false } } },
                animation: false 
            }
        });

        async function fetchMarketData() {
            try {
                const response = await fetch('/api/market-data');
                const data = await response.json();

                // 1. ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
                document.getElementById('stock-name').innerText = `${data.name} (${data.ticker})`;
                const priceEl = document.getElementById('current-price');
                const oldPrice = parseInt(priceEl.innerText.replace(/[^0-9]/g, '')) || 0;
                priceEl.innerText = `${data.price.toLocaleString()} KRW`;

                // 2. ê¹œë¹¡ì„ íš¨ê³¼
                if (data.price > oldPrice) priceEl.className = "display-3 fw-bold text-red price-up";
                else if (data.price < oldPrice) priceEl.className = "display-3 fw-bold text-blue price-down";

                // 3. ë‰´ìŠ¤ ì—…ë°ì´íŠ¸ (í•µì‹¬!)
                document.getElementById('news-text').innerText = data.news;

                // 4. ì°¨íŠ¸ ë°ì´í„° ë°€ì–´ë„£ê¸°
                if(data.history.length > 0) {
                    chart.data.labels = data.history.map(h => h.time);
                    chart.data.datasets[0].data = data.history.map(h => h.price);
                    chart.update();
                }

                // 5. í˜¸ê°€ì°½ ì—…ë°ì´íŠ¸
                const sellRows = data.sell_orders.length ? data.sell_orders.map(o => `<tr><td>${o.price}</td><td>${o.quantity}</td></tr>`).reverse().join('') : '<tr><td colspan="2" class="text-muted">- ë§¤ë„ ë¬¼ëŸ‰ ì—†ìŒ -</td></tr>';
                const buyRows = data.buy_orders.length ? data.buy_orders.map(o => `<tr><td>${o.price}</td><td>${o.quantity}</td></tr>`).join('') : '<tr><td colspan="2" class="text-muted">- ë§¤ìˆ˜ ë¬¼ëŸ‰ ì—†ìŒ -</td></tr>';
                
                document.getElementById('sell-book').innerHTML = sellRows;
                document.getElementById('buy-book').innerHTML = buyRows;

                // 6. ë©˜í†  ì—…ë°ì´íŠ¸
                if (data.mentors.length > 0) {
                    const mentorHtml = data.mentors.map(m => `
                        <div class="mentor-card ${m.style}">
                            <strong>${m.name}:</strong> ${m.msg}
                        </div>
                    `).join('');
                    document.getElementById('mentor-area').innerHTML = mentorHtml;
                }

            } catch (error) {
                console.error("Connection Error:", error);
            }
        }

        setInterval(fetchMarketData, 1000); // 1ì´ˆë§ˆë‹¤ ê°±ì‹ 
    </script>
</body>
</html>