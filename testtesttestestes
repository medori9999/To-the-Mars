import os
import json
import logging
from openai import AsyncAzureOpenAI
from dotenv import load_dotenv

load_dotenv()

# ğŸ”‘ Azure OpenAI ì„¸íŒ… (gpt-4o-mini ëª¨ë¸ ì ìš© ì™„ë£Œ)
client = AsyncAzureOpenAI(
    api_key=os.getenv("AZURE_OPENAI_API_KEY"),
    api_version=os.getenv("AZURE_OPENAI_API_VERSION", "2024-02-15-preview"),
    azure_endpoint=os.getenv("AZURE_OPENAI_ENDPOINT")
)
DEPLOYMENT_NAME = os.getenv("AZURE_OPENAI_DEPLOYMENT_NAME", "gpt-4o-mini")

async def agent_society_think(agent_name, agent_state, context_info, current_price, cash, portfolio_qty, avg_price, last_action_desc, market_sentiment):
    # ğŸš€ [ìµœì í™” 1] í”„ë¡¬í”„íŠ¸ ë‹¤ì´ì–´íŠ¸ (Prompt Efficiency)
    # ì¥í™©í•œ ì„¤ëª…ì€ ë¹¼ê³ , LLMì´ ì•Œì•„ë“£ëŠ” ìµœì†Œí•œì˜ ì§€ì‹œì–´ë§Œ ë‚¨ê²¨ í† í° ë‚­ë¹„ ì°¨ë‹¨
    sys_prompt = (
        "You are an AI stock trader. Act based on data.\n"
        "Output strictly in JSON: {\"action\": \"BUY\"|\"SELL\"|\"HOLD\", \"quantity\": int, \"price\": int, \"thought_process\": \"short reason\"}"
    )
    
    user_prompt = (
        f"State: Cash {cash}, Shares {portfolio_qty} (Avg {avg_price}). Price: {current_price}\n"
        f"News: {context_info}\n" 
        f"Market: {market_sentiment}"
    )

    try:
        # ê°’ì‹¸ê³  ë¹ ë¥¸ gpt-4o-mini í˜¸ì¶œ
        response = await client.chat.completions.create(
            model=DEPLOYMENT_NAME,
            messages=[
                {"role": "system", "content": sys_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.2,
            response_format={"type": "json_object"}
        )
        
        # ğŸš€ [ìµœì í™” 2] Self-Refine (ìê°€ ê²€ì¦) ì˜¤í¼ë ˆì´í„°
        # ë¹„ì‹¼ ì•™ìƒë¸”(3ëª… íˆ¬í‘œ)ì„ íì§€í•˜ê³ , ì¶œë ¥ëœ JSONì´ ê·œê²©ì— ì•ˆ ë§ì„ ë•Œë§Œ ë³´ìˆ˜ì (HOLD)ìœ¼ë¡œ ëŒ€ì²˜í•˜ì—¬ ë¬´í•œ ì¬í˜¸ì¶œ ë°©ì§€
        raw_content = response.choices[0].message.content
        decision = json.loads(raw_content)
        
        if decision.get("action") not in ["BUY", "SELL", "HOLD"]:
            decision["action"] = "HOLD" 
            
        return decision

    except Exception as e:
        logging.error(f"LLM Error: {e}")
        return {"action": "HOLD", "quantity": 0, "price": 0, "thought_process": "ì˜¤ë¥˜ ë°œìƒìœ¼ë¡œ ê´€ë§"}
        # =================================================================
# ğŸš€ [ìµœì í™” 3] ì •ë³´ ë‹¤ì´ì–´íŠ¸ & ë™ì  ë¼ìš°íŒ… (Dynamic Routing)
# =================================================================
# 1) ì •ë³´ ë‹¤ì´ì–´íŠ¸: ë‰´ìŠ¤ë‚˜ ì»¤ë®¤ë‹ˆí‹° ê¸€ì„ ì „ë¶€ ì•ˆ ë³´ë‚´ê³  ë”± 2ê°œë§Œ ëŠì–´ì„œ ë³´ëƒ„!
news_text = news_text[:200] # í…ìŠ¤íŠ¸ ê¸¸ì´ ê°•ì œ ì••ì¶•
social_context = social_context[:150]

# 2) ë™ì  ë¼ìš°íŒ…: ì¥ì´ ë¯¸ì³ ë‚ ë›¸ ë•ŒëŠ” LLM(í† í°)ì„ ì“°ì§€ ì•Šê³  30% í™•ë¥ ë¡œ ë‡Œë™ë§¤ë§¤(ì¶©ë™ ë§¤ë§¤) ìˆ˜í–‰!
if "ê¸‰ë“±ì„¸" in trend_info and random.random() < 0.3:
    decision = {
        "action": "BUY", 
        "quantity": random.randint(10, 30), 
        "price": int(company.current_price * 1.02), 
        "thought_process": "ì‹œì¥ ê¸‰ë“± í¬ëª¨(FOMO)ë¡œ ì¸í•œ ì‹œì¥ê°€ ì¶”ê²© ë§¤ìˆ˜ (LLM ìŠ¤í‚µ - í† í° 0ì›!)"
    }
elif "ê¸‰ë½ì„¸" in trend_info and random.random() < 0.3:
    decision = {
        "action": "SELL", 
        "quantity": random.randint(10, 30), 
        "price": int(company.current_price * 0.98), 
        "thought_process": "ì‹œì¥ ê¸‰ë½ ê³µí¬ë¡œ ì¸í•œ íŒ¨ë‹‰ ì…€ (LLM ìŠ¤í‚µ - í† í° 0ì›!)"
    }
else:
    # ì‹œì¥ì´ í‰ì˜¨í•˜ê±°ë‚˜ ì‹ ì¤‘í•´ì•¼ í•  ë•Œë§Œ LLMì„ í˜¸ì¶œ (ë¹„ìš© ìµœì í™”)
    decision = await agent_society_think(
        agent_name=agent.agent_id,
        agent_state=AgentState(**agent.psychology),
        context_info=news_text,
        current_price=company.current_price,
        cash=agent.cash_balance,
        portfolio_qty=portfolio_qty,
        avg_price=avg_price,
        last_action_desc=last_thought,
        market_sentiment=f"{trend_info} / {social_context}"
    )
# =================================================================